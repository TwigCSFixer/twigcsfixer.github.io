{% extends 'layout/base.html.twig' %}

{% block stylesheets %}
    <script>
        class TOC {
            constructor() {
                this.tocLinks = document.querySelectorAll('.toc__list a[href^="#"]');
                this.sections = new Map();
                this.currentSection = null;
                this.init();
            }

            init() {
                if (this.tocLinks.length === 0) return;
                this.setupSections();
                this.createObserver();
                this.observeSections();
            }

            setupSections() {
                this.tocLinks.forEach(link => {
                    const id = link.getAttribute('href').substring(1);
                    const section = document.getElementById(id);
                    if (section) {
                        this.sections.set(section, link);
                    }
                });
            }

            createObserver() {
                const options = {
                    root: null,
                    rootMargin: '-20% 0px -60% 0px',
                    threshold: [0, 0.1, 0.5, 1]
                };
                this.observer = new IntersectionObserver((entries) => {
                    this.handleIntersection(entries);
                }, options);
            }

            observeSections() {
                this.sections.forEach((link, section) => {
                    this.observer.observe(section);
                });
            }

            handleIntersection(entries) {
                const visibleSections = entries
                    .filter(entry => entry.isIntersecting)
                    .sort((a, b) => a.target.offsetTop - b.target.offsetTop);
                if (visibleSections.length > 0) {
                    const topSection = visibleSections[0].target;
                    this.setCurrentSection(topSection);
                }
            }

            setCurrentSection(section) {
                if (this.currentSection === section) return;
                this.clearCurrentSections();
                this.currentSection = section;
                const link = this.sections.get(section);
                if (link) {
                    link.parentElement.classList.add('toc__item--current');
                    link.setAttribute('aria-current', 'true');
                }
            }

            clearCurrentSections() {
                this.tocLinks.forEach(link => {
                    link.parentElement.classList.remove('toc__item--current');
                    link.removeAttribute('aria-current');
                });
            }

            destroy() {
                if (this.observer) {
                    this.observer.disconnect();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.tocHighlighter = new TOC();

            const tocLayout = document.querySelector('.toc-layout');
            const tocToggle = document.querySelector('.toc-toggle');
            const tocContainer = document.querySelector('.toc-layout__toc');
            const mobileQuery = window.matchMedia('(max-width: 1023px)');

            if (tocToggle && tocContainer) {
                if (tocLayout) {
                    tocLayout.classList.add('has-toc-toggle');
                }

                const collapsedLabel = tocToggle.dataset.labelCollapsed || tocToggle.textContent.trim();
                const expandedLabel = tocToggle.dataset.labelExpanded || collapsedLabel;
                const setToggleLabel = (isOpen) => {
                    tocToggle.textContent = isOpen ? expandedLabel : collapsedLabel;
                };

                const syncState = () => {
                    if (mobileQuery.matches) {
                        tocContainer.classList.remove('is-open');
                        tocToggle.setAttribute('aria-expanded', 'false');
                        setToggleLabel(false);
                    } else {
                        tocContainer.classList.add('is-open');
                        tocToggle.setAttribute('aria-expanded', 'true');
                        setToggleLabel(true);
                    }
                };

                tocToggle.addEventListener('click', () => {
                    const isOpen = tocContainer.classList.toggle('is-open');
                    tocToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                    setToggleLabel(isOpen);
                });

                if (typeof mobileQuery.addEventListener === 'function') {
                    mobileQuery.addEventListener('change', syncState);
                } else if (typeof mobileQuery.addListener === 'function') {
                    mobileQuery.addListener(syncState);
                }

                syncState();
            }
        });
    </script>
{% endblock %}

{% set current_url = app.request.getRequestUri() %}

{% block header %}
    {{ include('layout/_header.html.twig', {current_url: current_url}) }}
{% endblock %}

{% block content %}

    <style>
        .page_header__leaf {
            position: absolute;
            top: 0;
            left: calc(50% - (var(--container-lg) / 2));
            aspect-ratio: 1 / 1;
            display: block;
            bottom:0;
            overflow-block: clip;
            img {
                display: block;
                height: 75%;
                width: auto;
                position: absolute;
                bottom:0;
            }
            img + img {
                filter: grayscale(1);
                scale: 3;
                opacity: 0.3;
                rotate: 15deg;
                transform-origin: center bottom;
                transform: translate(0, 20%);
                mix-blend-mode: soft-light;
            }
        }
    </style>

    <section class="page-header">
        <div class="page-header__container page-container">
            <h1 class="page-header__title">{{ page|title }}</h1>
        </div>
        <div class="page_header__leaf">
            <img src="/images/twig-cs-fixer-leaf.png" alt="Twig CS Fixer Logo">
            <img src="/images/twig-cs-fixer-leaf.png" alt="Twig CS Fixer Logo">
        </div>
    </section>

    <div class="page-container" id="content">
        <div class="toc-layout">
            {% set markdown_raw -%}{%- block markdown -%}{%- endblock -%}{%- endset %}
            {% set markdown_data = markdown_raw|markdown_with_toc %}

            {# Generate TOC #}
            <button
                type="button"
                class="toc-toggle"
                aria-controls="page-toc"
                aria-expanded="false"
                data-label-collapsed="Show table of contents"
                data-label-expanded="Hide table of contents"
            >
                Show table of contents
            </button>
            <div class="toc-layout__toc" id="page-toc">
                <div class="toc toc--sticky">
                    {# Generate the Table of Contents #}
                    {{ include('component/_toc.html.twig', {toc: markdown_data.toc}) }}
                </div>
            </div>

            <div class="toc-layout__content">
                {{ markdown_data.content|raw }}
            </div>
        </div>
    </div>

    {% if false %}
        {% block prev_next %}
            {# Section "Prev / Next" #}
            {{ include('component/_prev_next.html.twig', {
                links: {
                    '/installation': 'Installation Guide',
                },
            }) }}
        {% endblock %}
    {% endif %}

{% endblock %}
