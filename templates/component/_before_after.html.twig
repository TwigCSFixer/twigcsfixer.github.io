<style>
  #baBefore, #baAfter { color: var(--code-comment); }
  .ba-old {
    text-decoration: underline 2px solid #ef4444;
    background: rgba(239, 68, 68, .08);
    border-radius: 4px;
    color: #fff;
    animation: ba-flash-old 800ms ease-out forwards;
  }
  .ba-new {
    background: rgba(34, 197, 94, .18);
    color: #fff;
    border-radius: 4px;
    animation: ba-flash 800ms ease-out forwards;
  }
  @keyframes ba-flash {
    0%   { box-shadow: 0 0 0 0 rgba(34,197,94,.45); }
    70%  { box-shadow: 0 0 0 12px rgba(34,197,94,0); }
    100% { box-shadow: none; }
  }
  @keyframes ba-flash-old {
    0%   { box-shadow: 0 0 0 0 rgba(239, 68, 68, .45); }
    70%  { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
    100% { box-shadow: none; }
  }

</style>

<section class="code-demo"{% if id is defined %} id="{{ id }}"{% endif %}>
  <div class="code-demo__container page-container">
    <div class="code-demo__before-after">
      <div class="code-panel code-panel--before">
        <h3 class="code-panel__title">Before</h3>
        <div class="code-window">
          <div class="code-window__header">
            <span class="code-window__dot"></span>
            <span class="code-window__dot"></span>
            <span class="code-window__dot"></span>
          </div>
          <div class="code-window__body">
            <pre class="code-window__code"><code id="baBefore" class="nohighlight"></code></pre>
          </div>
        </div>
      </div>

      <div class="code-panel code-panel--after">
        <h3 class="code-panel__title">After</h3>
        <div class="code-window">
          <div class="code-window__header">
            <span class="code-window__dot"></span>
            <span class="code-window__dot"></span>
            <span class="code-window__dot"></span>
          </div>
          <div class="code-window__body">
            <pre class="code-window__code"><code id="baAfter" class="nohighlight"></code></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  {% verbatim %}
  (function() {
    'use strict';
    const escapeHtml = (s) => s
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');

    function renderWithHighlight(code, start, end, cls) {
      const a = escapeHtml(code.slice(0, start));
      const b = escapeHtml(code.slice(start, end));
      const c = escapeHtml(code.slice(end));
      return `${a}<span class="${cls}">${b}</span>${c}`;
    }

    const beforeEl = document.getElementById('baBefore');
    const afterEl  = document.getElementById('baAfter');

    const beforeCode = `{%if  user.active%}\n  <h2>{{ user.name | upper }}</h2>\n  <p>\n    {{ 'Joined:'~user.joinedAt|date(format="Y-m-d") }}\n  </p>\n\n\n  {{ include('user/card.html.twig', {\n     "id":user.id,\n     "show":true,\n  } ) }}\n{%endif%}`;

    const afterCode = `{% if user.active %}\n  <h2>{{ user.name|upper }}</h2>\n  <p>\n    {{ 'Joined:' ~ user.joinedAt|date(format: 'Y-m-d') }}\n  </p>\n  \n  {{ include("user/card.html.twig", {\n     id: user.id,\n     show: true,\n  }) }}\n{% endif %}`;

    const steps = [
      { from: `{%if  user.active%}`, to: `{% if user.active %}` },
      { from: ` | `, to: `|` },
      { from: `~`, to: ` ~ ` },
      { from: `format="Y-m-d"`, to: `format: 'Y-m-d'` },
      { from: `</p>\n\n\n  {{ include`, to: `</p>\n  \n  {{ include` },
      { from: `'user/card.html.twig'`, to: `"user/card.html.twig"` },
      { from: `"id":user.id`, to: `id: user.id` },
      { from: `"show":true,`, to: `show: true,` },
      { from: `} )`, to: `})` },
      { from: `{%endif%}`, to: `{% endif %}` },
    ];

    let running = false;
    let runToken = 0;

    function renderBefore() { if (beforeEl) beforeEl.innerHTML = escapeHtml(beforeCode); }
    function renderAfter() { if (afterEl) afterEl.innerHTML = escapeHtml(afterCode); }

    function reset() {
      renderBefore();
      if (afterEl) afterEl.innerHTML = escapeHtml(beforeCode);
    }

    async function runAnimationOnce() {
        if (running) return;
        running = true;
        const token = ++runToken;

        reset();
        let currentCode = beforeCode;

        const flashDelay = 800;
        const betweenDelay = 200;

        await new Promise(r => setTimeout(r, betweenDelay));

        for (const step of steps) {
            if (token !== runToken) { running = false; return; }

            const startIndex = currentCode.indexOf(step.from);
            if (startIndex === -1) {
                console.warn('Step not found', step, currentCode);
                continue;
            }
            const endIndex = startIndex + step.from.length;

            if (beforeEl) {
                beforeEl.innerHTML = renderWithHighlight(currentCode, startIndex, endIndex, 'ba-old');
            }

            const nextCode = currentCode.substring(0, startIndex) + step.to + currentCode.substring(endIndex);
            const newEndIndex = startIndex + step.to.length;

            if (afterEl) {
                afterEl.innerHTML = renderWithHighlight(nextCode, startIndex, newEndIndex, 'ba-new');
            }

            await new Promise(r => setTimeout(r, flashDelay));
            if (token !== runToken) { running = false; return; }

            currentCode = nextCode;
            if (afterEl) afterEl.innerHTML = escapeHtml(currentCode);

            await new Promise(r => setTimeout(r, betweenDelay));
        }

        renderAfter();
        renderBefore();
        running = false;
    }

    const section = beforeEl ? beforeEl.closest('section') : null;
    if (section) {
      const io = new IntersectionObserver((entries) => {
        const e = entries[0];
        if (e.isIntersecting) {
          runAnimationOnce();
        } else {
          runToken++;
          running = false;
          reset();
        }
      }, { root: null, rootMargin: '0px', threshold: 0.3 });
      io.observe(section);
    } else {
      runAnimationOnce();
    }
  })();
  {% endverbatim %}</script>
